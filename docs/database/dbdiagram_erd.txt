// ALX Project Nexus - E-Commerce Backend Database Schema
// Copy and paste this code into https://dbdiagram.io/d to generate the visual ERD
// Generated: August 7, 2025

// ============================================
// USER MANAGEMENT SYSTEM
// ============================================

Table users {
  id integer [pk, increment]
  email varchar(255) [unique, not null]
  password varchar(128) [not null]
  first_name varchar(150)
  last_name varchar(150)
  is_staff boolean [default: false]
  is_active boolean [default: true]
  date_joined timestamp [default: `CURRENT_TIMESTAMP`]
  last_login timestamp

  indexes {
    email [unique, name: 'idx_users_email']
    is_active [name: 'idx_users_active']
    is_staff [name: 'idx_users_staff']
  }
  
  Note: 'Extended user model for customers and administrators'
}

// ============================================
// PRODUCT CATALOG SYSTEM
// ============================================

Table categories {
  id integer [pk, increment]
  name varchar(255) [unique, not null]
  slug varchar(255) [unique, not null]
  description text
  is_active boolean [default: true]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    slug [unique, name: 'idx_categories_slug']
    is_active [name: 'idx_categories_active']
    name [name: 'idx_categories_name']
  }
  
  Note: 'Product categories for organization and filtering'
}

Table products {
  id integer [pk, increment]
  name varchar(255) [not null]
  slug varchar(255) [unique, not null]
  description text
  price decimal(10,2) [not null, note: 'Must be > 0']
  category_id integer [not null]
  sku varchar(100) [unique, not null]
  stock_quantity integer [default: 0, note: 'Must be >= 0']
  is_active boolean [default: true]
  is_featured boolean [default: false]
  created_by integer
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    name [name: 'idx_products_name']
    category_id [name: 'idx_products_category']
    sku [unique, name: 'idx_products_sku']
    is_active [name: 'idx_products_active']
    is_featured [name: 'idx_products_featured']
    price [name: 'idx_products_price']
    created_at [name: 'idx_products_created_at']
    (name, category_id) [name: 'idx_products_name_category']
  }
  
  Note: 'Core product catalog with inventory management and SEO-friendly slugs'
}

Table product_images {
  id integer [pk, increment]
  product_id integer [not null]
  image_url varchar(500) [not null]
  alt_text varchar(255)
  is_primary boolean [default: false]
  sort_order integer [default: 0]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    product_id [name: 'idx_product_images_product']
    is_primary [name: 'idx_product_images_primary']
    (product_id, sort_order) [name: 'idx_product_images_sort']
  }
  
  Note: 'Product images with primary image designation and custom ordering'
}

// ============================================
// SHOPPING CART SYSTEM
// ============================================

Table carts {
  id integer [pk, increment]
  user_id integer [unique, not null]
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    user_id [unique, name: 'idx_carts_user']
  }
  
  Note: 'One-to-one relationship: Each user has exactly one persistent cart'
}

Table cart_items {
  id integer [pk, increment]
  cart_id integer [not null]
  product_id integer [not null]
  quantity integer [not null, note: 'Must be > 0']
  added_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    cart_id [name: 'idx_cart_items_cart']
    product_id [name: 'idx_cart_items_product']
    (cart_id, product_id) [unique, name: 'idx_cart_items_unique']
  }
  
  Note: 'Unique constraint prevents duplicate products in same cart'
}

// ============================================
// ORDER MANAGEMENT SYSTEM
// ============================================

Table orders {
  id integer [pk, increment]
  order_number varchar(50) [unique, not null]
  user_id integer [not null]
  total_amount decimal(10,2) [not null, note: 'Must be > 0']
  status varchar(20) [default: 'pending', note: 'pending|confirmed|processing|shipped|delivered|cancelled']
  shipping_address json [not null]
  billing_address json
  payment_method varchar(50)
  notes text
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    user_id [name: 'idx_orders_user']
    status [name: 'idx_orders_status']
    order_number [unique, name: 'idx_orders_number']
    created_at [name: 'idx_orders_created_at']
    (user_id, status) [name: 'idx_orders_user_status']
  }
  
  Note: 'Orders with auto-generated order numbers and status tracking'
}

Table order_items {
  id integer [pk, increment]
  order_id integer [not null]
  product_id integer [not null]
  quantity integer [not null, note: 'Must be > 0']
  unit_price decimal(10,2) [not null, note: 'Price snapshot at order time']
  total_price decimal(10,2) [not null, note: 'quantity * unit_price']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    order_id [name: 'idx_order_items_order']
    product_id [name: 'idx_order_items_product']
  }
  
  Note: 'Order line items with price preservation for historical accuracy'
}

// ============================================
// REVIEW & RATING SYSTEM
// ============================================

Table reviews {
  id integer [pk, increment]
  user_id integer [not null]
  product_id integer [not null]
  rating integer [not null, note: '1-5 star rating']
  title varchar(255)
  comment text
  is_verified boolean [default: false, note: 'Verified purchase review']
  is_approved boolean [default: true, note: 'Moderation status']
  helpful_count integer [default: 0, note: 'Community helpfulness votes']
  created_at timestamp [default: `CURRENT_TIMESTAMP`]
  updated_at timestamp [default: `CURRENT_TIMESTAMP`]

  indexes {
    product_id [name: 'idx_reviews_product']
    user_id [name: 'idx_reviews_user']
    rating [name: 'idx_reviews_rating']
    is_approved [name: 'idx_reviews_approved']
    (product_id, rating) [name: 'idx_reviews_product_rating']
    (user_id, product_id) [unique, name: 'idx_reviews_unique']
  }
  
  Note: 'One review per user per product with moderation and verification'
}

// ============================================
// BUSINESS RELATIONSHIPS & CONSTRAINTS
// ============================================

// Primary Entity Relationships - One-to-One & One-to-Many
Ref: "users"."id" - "carts"."user_id"
Ref: "users"."id" < "orders"."user_id"
Ref: "users"."id" < "reviews"."user_id"
Ref: "users"."id" < "products"."created_by"

// Category & Product Relationships
Ref: "categories"."id" < "products"."category_id"

// Product Relationships - One-to-Many
Ref: "products"."id" < "product_images"."product_id"
Ref: "products"."id" < "cart_items"."product_id"
Ref: "products"."id" < "order_items"."product_id"
Ref: "products"."id" < "reviews"."product_id"

// Cart & Order Relationships - One-to-Many
Ref: "carts"."id" < "cart_items"."cart_id"
Ref: "orders"."id" < "order_items"."order_id"

// ============================================
// DATABASE DESIGN NOTES
// ============================================

Note design_principles {
  '''
  ðŸ“‹ ALX E-Commerce Backend - Database Design Principles
  
  ðŸ”¹ NORMALIZATION: Schema follows 3NF principles
  ðŸ”¹ PERFORMANCE: Strategic indexes for common query patterns
  ðŸ”¹ SCALABILITY: Designed to handle growth in users and products
  ðŸ”¹ DATA INTEGRITY: Foreign key constraints and check constraints
  ðŸ”¹ BUSINESS RULES: Enforced at database level where possible
  ðŸ”¹ AUDIT TRAIL: Created/updated timestamps on key entities
  
  Key Features:
  âœ… One cart per user (persistent shopping experience)
  âœ… Unique product reviews per user (prevents spam)
  âœ… Price preservation in orders (historical accuracy)
  âœ… Stock quantity validation (prevents overselling)
  âœ… Soft deletion with is_active flags
  âœ… SEO-friendly slugs for products and categories
  âœ… Primary image designation for products
  âœ… Order status tracking with predefined states
  
  Performance Optimizations:
  ðŸš€ Full-text search indexes on product names/descriptions
  ðŸš€ Composite indexes for common filter combinations
  ðŸš€ Unique indexes to prevent data duplication
  ðŸš€ Geographic indexes ready for location-based features
  '''
}
